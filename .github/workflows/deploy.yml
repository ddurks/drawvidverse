name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Deployment mode (select one)"
        required: false
        type: choice
        default: "auto"
        options:
          - auto
          - deploy-backend-infra
          - deploy-matchmaker
          - deploy-worldserver
          - destroy-infrastructure

env:
  AWS_REGION: us-east-2
  AWS_ACCOUNT_ID: 593615615124
  ECR_REGISTRY: 593615615124.dkr.ecr.us-east-2.amazonaws.com
  ECR_REPOSITORY: drawvidverse-worldserver

jobs:
  detect-changes:
    name: Detect Component Changes
    runs-on: ubuntu-latest
    outputs:
      backend-infra-changed: ${{ steps.changes.outputs.backend-infra-changed }}
      matchmaker-code-changed: ${{ steps.changes.outputs.matchmaker-code-changed }}
      worldserver-changed: ${{ steps.changes.outputs.worldserver-changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          MODE="${{ github.event.inputs.mode }}"

          # Handle manual deployment modes
          if [ "$MODE" = "deploy-backend-infra" ]; then
            echo "backend-infra-changed=true" >> $GITHUB_OUTPUT
            echo "matchmaker-code-changed=false" >> $GITHUB_OUTPUT
            echo "worldserver-changed=false" >> $GITHUB_OUTPUT
            echo "Manual mode: Deploying backend infrastructure (CDK stack)"
            exit 0
          fi

          if [ "$MODE" = "deploy-matchmaker" ]; then
            echo "backend-infra-changed=false" >> $GITHUB_OUTPUT
            echo "matchmaker-code-changed=true" >> $GITHUB_OUTPUT
            echo "worldserver-changed=false" >> $GITHUB_OUTPUT
            echo "Manual mode: Deploying matchmaker Lambda code only"
            exit 0
          fi

          if [ "$MODE" = "deploy-worldserver" ]; then
            echo "backend-infra-changed=false" >> $GITHUB_OUTPUT
            echo "matchmaker-code-changed=false" >> $GITHUB_OUTPUT
            echo "worldserver-changed=true" >> $GITHUB_OUTPUT
            echo "Manual mode: Deploying world server only"
            exit 0
          fi

          if [ "$MODE" = "destroy-infrastructure" ]; then
            echo "backend-infra-changed=false" >> $GITHUB_OUTPUT
            echo "matchmaker-code-changed=false" >> $GITHUB_OUTPUT
            echo "worldserver-changed=false" >> $GITHUB_OUTPUT
            echo "Manual mode: Infrastructure destruction triggered separately"
            exit 0
          fi

          # Auto mode (default): detect changes from git and distinguish infra vs code
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD)
          else
            # For push and workflow_dispatch auto mode, compare with previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check what changed
          BACKEND_INFRA_CHANGED=false
          MATCHMAKER_CODE_CHANGED=false
          WORLDSERVER_CHANGED=false

          # Infrastructure files trigger full CDK deploy (includes code)
          if echo "$CHANGED_FILES" | grep -qE "^packages/drawvid-matchmaker/infra/|^packages/drawvid-matchmaker/package.json|^games/"; then
            BACKEND_INFRA_CHANGED=true
            echo "Infrastructure changes detected - will run full CDK deploy"
          fi

          # Code-only changes (no infra) trigger fast Lambda update
          if echo "$CHANGED_FILES" | grep -qE "^packages/drawvid-matchmaker/src/|^packages/drawvid-matchmaker/bundle-lambdas"; then
            # Only set code-changed if infra didn't change (mutually exclusive)
            if [ "$BACKEND_INFRA_CHANGED" = "false" ]; then
              MATCHMAKER_CODE_CHANGED=true
              echo "Code-only changes detected - will run fast Lambda update"
            fi
          fi

          if echo "$CHANGED_FILES" | grep -qE "^packages/drawvid-worldserver/|^games/"; then
            WORLDSERVER_CHANGED=true
          fi

          echo "backend-infra-changed=$BACKEND_INFRA_CHANGED" >> $GITHUB_OUTPUT
          echo "matchmaker-code-changed=$MATCHMAKER_CODE_CHANGED" >> $GITHUB_OUTPUT
          echo "worldserver-changed=$WORLDSERVER_CHANGED" >> $GITHUB_OUTPUT

          echo "Backend infra changed: $BACKEND_INFRA_CHANGED"
          echo "Matchmaker code changed: $MATCHMAKER_CODE_CHANGED"
          echo "World server changed: $WORLDSERVER_CHANGED"

  deploy-backend-infra:
    name: Deploy Backend Infrastructure
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend-infra-changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install workspace dependencies
        run: npm install --workspaces

      - name: Bundle Lambda code
        run: |
          cd packages/drawvid-matchmaker
          npm install
          npm run bundle-lambdas
          echo "Lambda bundle created:"
          ls -la dist/lambda-bundle/ || echo "Lambda bundle directory not found"

      - name: Deploy backend infrastructure stack
        run: |
          cd packages/drawvid-matchmaker/infra
          npx cdk deploy --all --require-approval never
        env:
          GAME_KEY: cyberia

      - name: Build and push world server Docker image
        id: build
        run: |
          IMAGE_TAG=$(date +%s)
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          cd packages/drawvid-worldserver
          npm install
          cd ../..
          ./tools/scripts/build-worldserver.sh ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}

      - name: Deployment summary
        run: |
          echo "‚úÖ Backend infrastructure deployed successfully"
          echo "CDK Stack: DrawvidVerseMatchmakerStack"
          echo "Components: ECS Cluster, API Gateway, VPC, Load Balancer, Lambda Functions"
          echo "World Server Image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.build.outputs.image-tag }}"
          echo "Region: ${{ env.AWS_REGION }}"

  deploy-matchmaker:
    name: Deploy Matchmaker Lambda Code
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.matchmaker-code-changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install workspace dependencies
        run: npm install --workspaces

      - name: Install dependencies and build Lambda code
        run: |
          cd packages/drawvid-matchmaker
          npm install
          npm run bundle-lambdas
          echo "Lambda bundle created:"
          ls -la dist/lambda-bundle/ || echo "Lambda bundle directory not found"

      - name: Package Lambda code as ZIP
        run: |
          cd packages/drawvid-matchmaker/dist/lambda-bundle
          zip -r ../lambda-bundle.zip .
          ls -la ../lambda-bundle.zip

      - name: Update Lambda functions
        run: |
          STACK_NAME="DrawvidVerseMatchmakerStack"
          REGION="${{ env.AWS_REGION }}"
          BUNDLE_ZIP="packages/drawvid-matchmaker/dist/lambda-bundle.zip"

          echo "Getting Lambda function names from CloudFormation stack..."
          FUNCTIONS=$(aws cloudformation describe-stack-resources \
            --stack-name $STACK_NAME \
            --region $REGION \
            --query 'StackResources[?ResourceType==`AWS::Lambda::Function` && LogicalResourceId!=`CleanupHandler`].PhysicalResourceId' \
            --output text)

          echo "Found functions to update: $FUNCTIONS"

          # Update each Lambda function with the bundled code
          for FUNC in $FUNCTIONS; do
            echo "Updating function: $FUNC"
            aws lambda update-function-code \
              --function-name $FUNC \
              --zip-file fileb://$BUNDLE_ZIP \
              --region $REGION && echo "‚úÖ Updated $FUNC" || echo "‚ùå Failed to update $FUNC"
          done

      - name: Deployment summary
        run: |
          echo "‚úÖ Matchmaker Lambda functions updated"
          echo "New code deployed without infrastructure changes"
          echo "Code updated: connect, disconnect, default, message handlers"

  deploy-worldserver:
    name: Deploy World Server
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.worldserver-changed == 'true'
    outputs:
      image-tag: ${{ steps.build.outputs.image-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install workspace dependencies
        run: npm install --workspaces

      - name: Install dependencies
        run: |
          cd packages/drawvid-worldserver
          npm install

      - name: Ensure ECR repository exists
        run: |
          REGION="${{ env.AWS_REGION }}"
          REPO_NAME="${{ env.ECR_REPOSITORY }}"
          
          # Try to create the repository if it doesn't exist
          aws ecr create-repository \
            --repository-name $REPO_NAME \
            --region $REGION 2>/dev/null || true
          
          echo "‚úÖ ECR repository ready: $REPO_NAME"

      - name: Build world server image
        id: build
        run: |
          IMAGE_TAG=$(date +%s)
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          ./tools/scripts/build-worldserver.sh ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}

      - name: Update ECS task definition with new image
        run: |
          REGION="${{ env.AWS_REGION }}"
          IMAGE_TAG="${{ steps.build.outputs.image-tag }}"
          NEW_IMAGE="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG"
          STACK_NAME="DrawvidVerseMatchmakerStack"

          # Get task definition ARN from CloudFormation stack outputs
          TASK_DEF_ARN=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --region $REGION \
            --query 'Stacks[0].Outputs[?OutputKey==`TaskDefinitionArn`].OutputValue' \
            --output text)

          if [ -z "$TASK_DEF_ARN" ]; then
            echo "‚ùå Could not retrieve task definition ARN from CloudFormation stack"
            exit 1
          fi

          echo "Updating task definition with new image: $NEW_IMAGE"
          echo "Task definition ARN: $TASK_DEF_ARN"

          # Get current task definition
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition $TASK_DEF_ARN \
            --region $REGION \
            --output json)

          # Update image in task definition
          NEW_TASK_DEF=$(echo "$TASK_DEF" | jq --arg NEW_IMAGE "$NEW_IMAGE" \
            '.taskDefinition | .containerDefinitions[0].image = $NEW_IMAGE | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          # Register new task definition
          REGISTER_RESULT=$(aws ecs register-task-definition \
            --cli-input-json "$(echo "$NEW_TASK_DEF" | jq -c .)" \
            --region $REGION \
            --output json)

          NEW_TASK_DEF_ARN=$(echo "$REGISTER_RESULT" | jq -r '.taskDefinition.taskDefinitionArn')
          echo "‚úÖ Registered new task definition: $NEW_TASK_DEF_ARN"

      - name: Stop ECS tasks to pick up new image
        run: |
          CLUSTER="drawvidverse-cluster"
          REGION="${{ env.AWS_REGION }}"

          echo "Stopping all running ECS tasks..."
          TASKS=$(aws ecs list-tasks --cluster $CLUSTER --region $REGION --desired-status RUNNING --output text --query 'taskArns[]' 2>/dev/null || echo "")
          if [ -n "$TASKS" ]; then
            for TASK in $TASKS; do
              echo "Stopping $TASK"
              aws ecs stop-task --cluster $CLUSTER --task $TASK --region $REGION 2>/dev/null || true
            done
            echo "‚úÖ Tasks stopped - new tasks will use updated image on next startup"
          else
            echo "No running tasks found"
          fi

      - name: Deployment summary
        run: |
          echo "‚úÖ World server image built and pushed to ECR"
          echo "‚úÖ ECS task definition updated with new image tag"
          echo "‚úÖ ECS tasks stopped - Lambda will restart with new image"
          echo "Repository: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}"
          echo "Image tag: ${{ steps.build.outputs.image-tag }}"

  deployment-complete:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs:
      [
        detect-changes,
        deploy-backend-infra,
        deploy-matchmaker,
        deploy-worldserver,
      ]
    if: always()
    steps:
      - name: Check deployment results
        run: |
          echo "üöÄ Backend Deployment Pipeline Complete"
          echo ""
          echo "Component Summary:"
          echo "- Backend Infrastructure: ${{ needs.detect-changes.outputs.matchmaker-changed == 'true' && '‚úÖ Deployed' || '‚è≠Ô∏è  Skipped' }}"
          echo "- Matchmaker Lambda Code: ${{ needs.detect-changes.outputs.matchmaker-changed == 'true' && '‚úÖ Updated' || '‚è≠Ô∏è  Skipped' }}"
          echo "- World Server: ${{ needs.detect-changes.outputs.worldserver-changed == 'true' && '‚úÖ Deployed' || '‚è≠Ô∏è  Skipped' }}"
          echo ""
          echo "Note: Frontend deployment is handled by cyberia repository"
          echo ""
          echo "Production URLs:"
          echo "- Frontend: https://cyberia.drawvid.com"
          echo "- Matchmaker: wss://matchmaker.drawvid.com/prod"
          echo "- World Server: wss://world.drawvid.com:443"

      - name: Fail if any deployment failed
        if: |
          (needs.detect-changes.outputs.matchmaker-changed == 'true' && (needs.deploy-backend-infra.result == 'failure' || needs.deploy-matchmaker.result == 'failure')) ||
          (needs.detect-changes.outputs.worldserver-changed == 'true' && needs.deploy-worldserver.result == 'failure')
        run: |
          echo "‚ùå One or more deployments failed!"
          exit 1
  destroy-infrastructure:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    if: github.event.inputs.mode == 'destroy-infrastructure'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ‚ö†Ô∏è Confirm destruction
        run: |
          echo "‚ö†Ô∏è  WARNING: DESTROYING ALL INFRASTRUCTURE!"
          echo "This will:"
          echo "  - Delete CloudFormation stack (matchmaker)"
          echo "  - Terminate ECS tasks and services"
          echo "  - Delete DynamoDB tables"
          echo "  - Remove Lambda functions"
          echo "  - Delete VPCs, subnets, and security groups"
          echo ""
          echo "This action CANNOT be undone!"
          echo ""
          sleep 3

      - name: Destroy CloudFormation stack
        run: |
          STACK_NAME="DrawvidVerseMatchmakerStack"
          echo "Destroying stack: $STACK_NAME"
          aws cloudformation delete-stack --stack-name $STACK_NAME --region ${{ env.AWS_REGION }}
          echo "Stack deletion initiated..."

      - name: Wait for stack deletion
        run: |
          STACK_NAME="DrawvidVerseMatchmakerStack"
          echo "Waiting for stack deletion to complete (this may take several minutes)..."
          aws cloudformation wait stack-delete-complete \
            --stack-name $STACK_NAME \
            --region ${{ env.AWS_REGION }} || echo "Stack deletion completed or does not exist"

      - name: Destruction complete
        run: |
          echo "‚úÖ Infrastructure destruction initiated!"
          echo "All resources will be cleaned up within the next few minutes."
          echo ""
          echo "To verify deletion:"
          echo "  aws cloudformation describe-stacks --stack-name DrawvidVerseMatchmakerStack --region us-east-2"
