name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      deploy-matchmaker:
        description: "Deploy Matchmaker backend"
        required: false
        default: "false"
        type: boolean
      deploy-worldserver:
        description: "Deploy World Server"
        required: false
        default: "false"
        type: boolean
      deploy-all:
        description: "Deploy everything (overrides individual selections)"
        required: false
        default: "false"
        type: boolean
      destroy-infrastructure:
        description: "‚ö†Ô∏è DESTROY infrastructure (cannot be undone!)"
        required: false
        default: "false"
        type: boolean

env:
  AWS_REGION: us-east-2
  AWS_ACCOUNT_ID: 593615615124
  ECR_REGISTRY: 593615615124.dkr.ecr.us-east-2.amazonaws.com
  ECR_REPOSITORY: drawvidverse-worldserver

jobs:
  detect-changes:
    name: Detect Component Changes
    runs-on: ubuntu-latest
    outputs:
      matchmaker-changed: ${{ steps.changes.outputs.matchmaker }}
      worldserver-changed: ${{ steps.changes.outputs.worldserver }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          # If manually triggered with deploy-all flag, deploy everything
          if [ "${{ github.event.inputs.deploy-all }}" == "true" ]; then
            echo "matchmaker=true" >> $GITHUB_OUTPUT
            echo "worldserver=true" >> $GITHUB_OUTPUT
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "Manual trigger: Deploying all components"
            exit 0
          fi

          # If manually triggered, use selected inputs
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "matchmaker=${{ github.event.inputs.deploy-matchmaker }}" >> $GITHUB_OUTPUT
            echo "worldserver=${{ github.event.inputs.deploy-worldserver }}" >> $GITHUB_OUTPUT
            echo "frontend=${{ github.event.inputs.deploy-frontend }}" >> $GITHUB_OUTPUT
            echo "Manual trigger: Deploying selected components"
            exit 0
          fi

          # Otherwise detect changes from git
          # Get the list of changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD)
          else
            # For push events, compare with previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check which components changed
          MATCHMAKER_CHANGED=false
          WORLDSERVER_CHANGED=false
          FRONTEND_CHANGED=false

          if echo "$CHANGED_FILES" | grep -qE "^packages/drawvid-matchmaker/|^games/"; then
            MATCHMAKER_CHANGED=true
          fi

          if echo "$CHANGED_FILES" | grep -qE "^packages/drawvid-worldserver/|^games/"; then
            WORLDSERVER_CHANGED=true
          fi

          if echo "$CHANGED_FILES" | grep -qE "^cyberia/"; then
            FRONTEND_CHANGED=true
          fi

          echo "matchmaker=$MATCHMAKER_CHANGED" >> $GITHUB_OUTPUT
          echo "worldserver=$WORLDSERVER_CHANGED" >> $GITHUB_OUTPUT
          echo "frontend=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT

          echo "Matchmaker changed: $MATCHMAKER_CHANGED"
          echo "World server changed: $WORLDSERVER_CHANGED"
          echo "Frontend changed: $FRONTEND_CHANGED"

  deploy-matchmaker:
    name: Deploy Matchmaker
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.matchmaker-changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install workspace dependencies
        run: npm install --workspaces

      - name: Install dependencies
        run: |
          cd packages/drawvid-matchmaker
          npm install

      - name: Build matchmaker
        run: |
          cd packages/drawvid-matchmaker
          npm run build
          echo "Lambda bundle contents:"
          ls -la dist/lambda-bundle/ || echo "Lambda bundle directory not found"

      - name: Deploy matchmaker stack
        run: |
          cd packages/drawvid-matchmaker/infra
          npx cdk deploy --all --require-approval never
        env:
          GAME_KEY: cyberia

      - name: Deployment summary
        run: |
          echo "‚úÖ Matchmaker deployed successfully"
          echo "CDK Stack: DrawvidVerseMatchmakerStack"
          echo "Region: ${{ env.AWS_REGION }}"

  deploy-worldserver:
    name: Deploy World Server
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.worldserver-changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install workspace dependencies
        run: npm install --workspaces

      - name: Install dependencies
        run: |
          cd packages/drawvid-worldserver
          npm install

      - name: Build world server image
        run: |
          ./tools/scripts/build-worldserver.sh ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}

      - name: Stop ECS tasks to pick up new image
        run: |
          CLUSTER="drawvidverse-cluster"
          REGION="${{ env.AWS_REGION }}"
          
          echo "Stopping all running ECS tasks..."
          TASKS=$(aws ecs list-tasks --cluster $CLUSTER --region $REGION --desired-status RUNNING --output text --query 'taskArns[]' 2>/dev/null || echo "")
          if [ -n "$TASKS" ]; then
            for TASK in $TASKS; do
              echo "Stopping $TASK"
              aws ecs stop-task --cluster $CLUSTER --task $TASK --region $REGION 2>/dev/null || true
            done
            echo "Tasks stopped"
          else
            echo "No running tasks found"
          fi

      - name: Clean up stale world records from DynamoDB
        run: |
          STACK_NAME="DrawvidVerseMatchmakerStack"
          REGION="${{ env.AWS_REGION }}"
          
          echo "Getting DynamoDB table name from CloudFormation..."
          TABLE_NAME=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --region $REGION \
            --query 'Stacks[0].Outputs[?OutputKey==`WorldsTableName`].OutputValue' \
            --output text 2>/dev/null)
          
          if [ -z "$TABLE_NAME" ]; then
            echo "Could not find table name, skipping DynamoDB cleanup"
            exit 0
          fi
          
          echo "Cleaning up world records from table: $TABLE_NAME"
          
          # Query for all world items (pk starts with "world_")
          ITEMS=$(aws dynamodb query \
            --table-name $TABLE_NAME \
            --key-condition-expression "begins_with(pk, :pk)" \
            --expression-attribute-values '{":pk":{"S":"world_"}}' \
            --region $REGION \
            --output json 2>/dev/null || echo '{"Items":[]}')
          
          # Delete each item
          echo "$ITEMS" | jq -r '.Items[] | @base64' | while read item; do
            DECODED=$(echo $item | base64 -d)
            PK=$(echo "$DECODED" | jq -r '.pk.S')
            SK=$(echo "$DECODED" | jq -r '.sk.S')
            
            if [ -n "$PK" ] && [ -n "$SK" ]; then
              echo "Deleting world record: $PK / $SK"
              aws dynamodb delete-item \
                --table-name $TABLE_NAME \
                --key "{\"pk\":{\"S\":\"$PK\"},\"sk\":{\"S\":\"$SK\"}}" \
                --region $REGION 2>/dev/null || true
            fi
          done
          
          echo "DynamoDB cleanup complete"

      - name: Deployment summary
        run: |
          echo "‚úÖ World server image built and pushed to ECR"
          echo "‚úÖ ECS tasks stopped"
          echo "‚úÖ Stale world records cleaned from DynamoDB"
          echo "‚úÖ Lambda will restart tasks with new image"
          echo "Repository: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}"




  deployment-complete:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-matchmaker, deploy-worldserver]
    if: always()
    steps:
      - name: Check deployment results
        run: |
          echo "üöÄ Backend Deployment Pipeline Complete"
          echo ""
          echo "Component Summary:"
          echo "- Matchmaker: ${{ needs.detect-changes.outputs.matchmaker-changed == 'true' && '‚úÖ Deployed' || '‚è≠Ô∏è  Skipped' }}"
          echo "- World Server: ${{ needs.detect-changes.outputs.worldserver-changed == 'true' && '‚úÖ Deployed' || '‚è≠Ô∏è  Skipped' }}"
          echo ""
          echo "Note: Frontend deployment is handled by cyberia repository"
          echo ""
          echo "Production URLs:"
          echo "- Frontend: https://cyberia.drawvid.com"
          echo "- Matchmaker: wss://matchmaker.drawvid.com/prod"
          echo "- World Server: wss://world.drawvid.com:443"

      - name: Fail if any deployment failed
        if: |
          (needs.detect-changes.outputs.matchmaker-changed == 'true' && needs.deploy-matchmaker.result == 'failure') ||
          (needs.detect-changes.outputs.worldserver-changed == 'true' && needs.deploy-worldserver.result == 'failure')
        run: |
          echo "‚ùå One or more deployments failed!"
          exit 1
  destroy-infrastructure:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    if: github.event.inputs.destroy-infrastructure == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ‚ö†Ô∏è Confirm destruction
        run: |
          echo "‚ö†Ô∏è  WARNING: DESTROYING ALL INFRASTRUCTURE!"
          echo "This will:"
          echo "  - Delete CloudFormation stack (matchmaker)"
          echo "  - Terminate ECS tasks and services"
          echo "  - Delete DynamoDB tables"
          echo "  - Remove Lambda functions"
          echo "  - Delete VPCs, subnets, and security groups"
          echo ""
          echo "This action CANNOT be undone!"
          echo ""
          sleep 3

      - name: Destroy CloudFormation stack
        run: |
          STACK_NAME="DrawvidVerseMatchmakerStack"
          echo "Destroying stack: $STACK_NAME"
          aws cloudformation delete-stack --stack-name $STACK_NAME --region ${{ env.AWS_REGION }}
          echo "Stack deletion initiated..."

      - name: Wait for stack deletion
        run: |
          STACK_NAME="DrawvidVerseMatchmakerStack"
          echo "Waiting for stack deletion to complete (this may take several minutes)..."
          aws cloudformation wait stack-delete-complete \
            --stack-name $STACK_NAME \
            --region ${{ env.AWS_REGION }} || echo "Stack deletion completed or does not exist"

      - name: Destruction complete
        run: |
          echo "‚úÖ Infrastructure destruction initiated!"
          echo "All resources will be cleaned up within the next few minutes."
          echo ""
          echo "To verify deletion:"
          echo "  aws cloudformation describe-stacks --stack-name DrawvidVerseMatchmakerStack --region us-east-2"
